using System;
using HarmonyLib;
using QuickWheel.Core.Interfaces;
using QuickWheel.UI;
using UnityEngine;
using UnityEngine.UI;

namespace ItemWheel
{
    /// <summary>
    /// ä¸?QuickWheel çš?WheelSlotDisplay æ·»åŠ ç¨€æœ‰åº¦åº•è‰²ã€å³ä¾§æ–‡å­—ä¸è€ä¹…æ¡çš„è£…é¥°æ¸²æŸ“ã€?    /// ä¸ç›´æ¥ä¿®æ”?QuickWheel æºæ–‡ä»¶ï¼Œä½¿ç”¨ Harmony åç½®å¤„ç†ã€?    /// </summary>
    [HarmonyPatch]
    internal static class WheelSlotDecorPatch
    {
        private static Transform EnsureChild(this Transform parent, string name)
        {
            var t = parent.Find(name);
            if (t != null) return t;
            var go = new GameObject(name);
            go.transform.SetParent(parent, false);
            return go.transform;
        }

        [HarmonyPatch(typeof(WheelSlotDisplay), "CreateDisplay")]
        [HarmonyPostfix]
        private static void CreateDisplay_Postfix(WheelSlotDisplay __instance)
        {
            var root = __instance != null ? __instance.transform : null;
            if (root == null) return;
            try {
            // ç¨€æœ‰åº¦åº•è‰²
            var tint = root.EnsureChild("RarityTint");
            var tintRect = tint.GetComponent<RectTransform>() ?? tint.gameObject.AddComponent<RectTransform>();
            tintRect.anchorMin = Vector2.zero;
            tintRect.anchorMax = Vector2.one;
            tintRect.offsetMin = Vector2.zero;
            tintRect.offsetMax = Vector2.zero;
            var tintImg = tint.GetComponent<Image>() ?? tint.gameObject.AddComponent<Image>();
            tintImg.raycastTarget = false;
            tintImg.color = new Color(1, 1, 1, 0);
            // æ”¾åœ¨èƒŒæ™¯ä¹‹ä¸Šã€å›¾æ ‡ä¹‹ä¸‹ï¼ˆèƒŒæ™¯ä¸€èˆ¬æ˜¯ç¬?ä¸ªå­ç‰©ä½“ï¼?            tint.SetSiblingIndex(1);

            // å³ä¾§æ–‡å­—
            var right = root.EnsureChild("RightText");
            var rightText = right.GetComponent<Text>() ?? right.gameObject.AddComponent<Text>();
            rightText.font = Resources.GetBuiltinResource<Font>("Arial.ttf");
            rightText.fontSize = 12;
            rightText.alignment = TextAnchor.LowerRight;
            rightText.color = Color.white;
            rightText.raycastTarget = false;
            var rightRect = right.GetComponent<RectTransform>();
            rightRect.anchorMin = new Vector2(0, 0.25f);
            rightRect.anchorMax = new Vector2(1, 0.45f);
            rightRect.offsetMin = new Vector2(6, 0);
            rightRect.offsetMax = new Vector2(-6, 0);
            right.gameObject.SetActive(false);

            // è€ä¹…æ¡ï¼šèƒŒæ™¯+å¡«å……
            var durBg = root.EnsureChild("DurabilityBg");
            var durBgImg = durBg.GetComponent<Image>() ?? durBg.gameObject.AddComponent<Image>();
            durBgImg.color = new Color(1, 1, 1, 0.2f);
            durBgImg.raycastTarget = false;
            var durBgRect = durBg.GetComponent<RectTransform>();
            durBgRect.anchorMin = new Vector2(0.5f, 0.45f);
            durBgRect.anchorMax = new Vector2(1f, 0.55f);
            durBgRect.offsetMin = new Vector2(0, 0);
            durBgRect.offsetMax = new Vector2(-6, 0);
            durBg.gameObject.SetActive(false);

            var durFill = root.EnsureChild("DurabilityFill");
            var durFillImg = durFill.GetComponent<Image>() ?? durFill.gameObject.AddComponent<Image>();
            durFillImg.color = new Color(0.4f, 0.9f, 0.4f, 0.9f);
            durFillImg.raycastTarget = false;
            var durFillRect = durFill.GetComponent<RectTransform>();
            durFillRect.anchorMin = new Vector2(0.5f, 0.45f);
            durFillRect.anchorMax = new Vector2(0.5f, 0.55f);
            durFillRect.pivot = new Vector2(1f, 0.5f);
            durFillRect.offsetMin = new Vector2(0, 0);
            durFillRect.offsetMax = new Vector2(-6, 0);
            durFill.gameObject.SetActive(false);

            // åç§°æ–‡æœ¬æ”¹ä¸ºå³ä¸‹å¯¹é½
            var label = root.Find("Label");
            if (label != null)
            {
                var labelText = label.GetComponent<Text>();
                if (labelText != null)
                {
                    labelText.alignment = TextAnchor.LowerRight;
                    var lr = label.GetComponent<RectTransform>();
                    lr.anchorMin = new Vector2(0, 0);
                    lr.anchorMax = new Vector2(1, 0.25f);
                    lr.offsetMin = new Vector2(6, 2);
                    lr.offsetMax = new Vector2(-6, 0);
                }
            }
            catch (Exception ex)
            {
                Debug.LogWarning($"[WheelDecor] CreateDisplay postfix failed: {ex.Message}");
            }
        }

        [HarmonyPatch(typeof(WheelSlotDisplay), "SetData")]
        [HarmonyPostfix]
        private static void SetData_Postfix(WheelSlotDisplay __instance, IWheelItem wheelItem)
        {
            if (__instance == null) return;
            var root = __instance.transform;
            var tint = root.Find("RarityTint");
            var right = root.Find("RightText");
            var durBg = root.Find("DurabilityBg");
            var durFill = root.Find("DurabilityFill");

            var decor = wheelItem as IWheelItemDecor;
            if (decor == null)
            {
                if (tint)
                {
                    var img = tint.GetComponent<Image>();
                    if (img != null) img.color = new Color(1, 1, 1, 0);
                }
                if (right) right.gameObject.SetActive(false);
                if (durBg) durBg.gameObject.SetActive(false);
                if (durFill) durFill.gameObject.SetActive(false);
                return;
            }

            // ç¨€æœ‰åº¦åº•è‰²
            var tintColor = decor.GetRarityTint();
            if (tint)
            {
                var img = tint.GetComponent<Image>();
                img.color = tintColor.HasValue ? tintColor.Value : new Color(1, 1, 1, 0);
            }

            // å³ä¾§æ–‡å­—
            var rightText = decor.GetRightText();
            if (right)
            {
                var txt = right.GetComponent<Text>();
                if (!string.IsNullOrEmpty(rightText))
                {
                    txt.text = rightText;
                    txt.alignment = TextAnchor.LowerRight;
                    right.gameObject.SetActive(true);
                }
                else
                {
                    right.gameObject.SetActive(false);
                }
            }

            // è€ä¹…æ?            var d = decor.GetDurability01();
            if (d.HasValue && d.Value > 0f)
            {
                if (durBg) durBg.gameObject.SetActive(true);
                if (durFill)
                {
                    durFill.gameObject.SetActive(true);
                    float pct = Mathf.Clamp01(d.Value);
                    // ä½¿ç”¨é”šç‚¹å˜åŒ–è¡¨ç¤ºæ¯”ä¾‹ï¼šä»å³ä¾§å‘å·¦æ”¶ç¼©
                    var fillRect = durFill.GetComponent<RectTransform>();
                    fillRect.anchorMin = new Vector2(1f - 0.5f * pct, fillRect.anchorMin.y);
                    fillRect.anchorMax = new Vector2(1f, fillRect.anchorMax.y);
                }
            }
            else
            {
                if (durBg) durBg.gameObject.SetActive(false);
                if (durFill) durFill.gameObject.SetActive(false);
            }

            // åç§°å³ä¸‹å¯¹é½
            var label = root.Find("Label");
            if (label != null)
            {
                var labelText = label.GetComponent<Text>();
                if (labelText != null)
                {
                    labelText.alignment = TextAnchor.LowerRight;
                }
            }
        }
    }
}





