# è½®ç›˜æ‹–æ‹½åŒæ­¥èƒŒåŒ…åŠŸèƒ½ - å®ç°æ€»ç»“

*å®Œæˆæ—¶é—´: 2025-11-07*

---

## âœ… åŠŸèƒ½å®Œæˆ

### æ ¸å¿ƒåŠŸèƒ½
å®ç°äº†**è½®ç›˜æ‹–æ‹½åŒæ­¥åˆ°èƒŒåŒ…**çš„å®Œæ•´åŠŸèƒ½é“¾è·¯ï¼Œç©å®¶å¯ä»¥åœ¨è½®ç›˜ä¸Šæ‹–æ‹½ç‰©å“è°ƒæ•´é¡ºåºï¼ŒåŒæ—¶åŒæ­¥æ›´æ–°èƒŒåŒ…ä¸­çš„ç‰©å“ä½ç½®ã€‚

---

## ğŸ”§ å®ç°ç»†èŠ‚

### 1. **æ•°æ®ç»“æ„ï¼šåŒå‘æ˜ å°„** (`ItemWheelSystem.cs`)

åœ¨ `CategoryWheel` ç±»ä¸­æ·»åŠ äº†åŒå‘æ˜ å°„æœºåˆ¶ï¼š

```csharp
public class CategoryWheel
{
    // è½®ç›˜ä½ç½®[0-7] â†’ èƒŒåŒ…ä½ç½®
    public int[] WheelToBackpackMapping;

    // èƒŒåŒ…ä½ç½® â†’ è½®ç›˜ä½ç½®
    public Dictionary<int, int> BackpackToWheelMapping;

    public CategoryWheel()
    {
        WheelToBackpackMapping = new int[8];
        Array.Fill(WheelToBackpackMapping, -1);  // -1è¡¨ç¤ºç©ºä½
        BackpackToWheelMapping = new Dictionary<int, int>();
    }
}
```

**ä½ç½®**: `ItemWheelSystem.cs:39-59`

---

### 2. **åˆå§‹åŒ–æ˜ å°„** (`ItemWheelSystem.cs:500-531`)

åœ¨ `RefreshCategorySlots` æ–¹æ³•ä¸­å»ºç«‹è½®ç›˜ä¸èƒŒåŒ…çš„æ˜ å°„å…³ç³»ï¼š

```csharp
// æ¸…ç©ºæ—§æ˜ å°„
Array.Fill(wheel.WheelToBackpackMapping, -1);
wheel.BackpackToWheelMapping.Clear();

foreach (Item collectedItem in collected)
{
    // ... æ·»åŠ åˆ°æ§½ä½ ...

    // å»ºç«‹æ˜ å°„å…³ç³»
    int backpackPos = _inventory.Content.IndexOf(collectedItem);
    if (backpackPos >= 0)
    {
        wheel.WheelToBackpackMapping[bufferIndex] = backpackPos;
        wheel.BackpackToWheelMapping[backpackPos] = bufferIndex;
    }
}
```

---

### 3. **é˜²æ­¢é€’å½’äº‹ä»¶** (`ItemWheelSystem.cs:76, 470-474`)

æ·»åŠ äº† `_isPerformingSwap` æ ‡å¿—é˜²æ­¢äº‹ä»¶å¾ªç¯ï¼š

```csharp
// å…¨å±€æ ‡å¿—
private bool _isPerformingSwap = false;

// åœ¨ RefreshCategorySlots ä¸­æ£€æŸ¥
if (_isPerformingSwap)
{
    Debug.Log($"[ItemWheel] Swap in progress, skip refresh");
    return true;
}
```

---

### 4. **è®¢é˜…æ§½ä½äº¤æ¢äº‹ä»¶** (`ItemWheelSystem.cs:454-459`)

åœ¨ `EnsureWheel` æ–¹æ³•ä¸­è®¢é˜… QuickWheel çš„ `OnSlotsSwapped` äº‹ä»¶ï¼š

```csharp
// è®¢é˜…æ§½ä½äº¤æ¢äº‹ä»¶
wheel.EventBus.OnSlotsSwapped += (fromIndex, toIndex) =>
{
    Debug.Log($"[ItemWheel] Wheel slots swapped: {category}, {fromIndex} <-> {toIndex}");
    OnWheelSlotsSwapped(context, fromIndex, toIndex);
};
```

---

### 5. **èƒŒåŒ…åŒæ­¥é€»è¾‘** (`ItemWheelSystem.cs:742-856`)

å®ç°äº† `OnWheelSlotsSwapped` æ–¹æ³•ï¼Œå¤„ç†ä¸¤ç§æƒ…å†µï¼š

#### æƒ…å†µ1ï¼šç›®æ ‡ä½ç½®æœ‰ç‰©å“ï¼ˆåŒå‘äº¤æ¢ï¼‰

```csharp
if (toBackpackPos != -1)
{
    var item = _inventory.GetItemAt(fromBackpackPos);
    var targetItem = _inventory.GetItemAt(toBackpackPos);

    // ä»èƒŒåŒ…ä¸­å–å‡º
    item.Detach();
    targetItem.Detach();

    // äº¤æ¢ä½ç½®é‡æ–°æ”¾å…¥
    _inventory.AddAt(targetItem, fromBackpackPos);
    _inventory.AddAt(item, toBackpackPos);

    // æ›´æ–°æ˜ å°„å…³ç³»
    wheel.WheelToBackpackMapping[fromWheelPos] = toBackpackPos;
    wheel.WheelToBackpackMapping[toWheelPos] = fromBackpackPos;
    wheel.BackpackToWheelMapping[toBackpackPos] = fromWheelPos;
    wheel.BackpackToWheelMapping[fromBackpackPos] = toWheelPos;
}
```

#### æƒ…å†µ2ï¼šç›®æ ‡ä½ç½®ä¸ºç©ºï¼ˆåªæ›´æ–°æ˜ å°„ï¼‰

```csharp
else
{
    // åªæ›´æ–°æ˜ å°„ï¼Œä¸æ“ä½œèƒŒåŒ…
    wheel.WheelToBackpackMapping[fromWheelPos] = -1;
    wheel.WheelToBackpackMapping[toWheelPos] = fromBackpackPos;
    wheel.BackpackToWheelMapping[fromBackpackPos] = toWheelPos;
}
```

---

### 6. **QuickWheel æ‹–æ‹½åŠŸèƒ½** (æ–°å¢)

ç”±äº QuickWheel åŸæœ¬æ²¡æœ‰æ‹–æ‹½åŠŸèƒ½ï¼Œæˆ‘ä»¬å®Œæ•´å®ç°äº†UIæ‹–æ‹½ç³»ç»Ÿï¼š

#### 6.1 `WheelSlotDisplay.cs` - å®ç°æ‹–æ‹½æ¥å£

```csharp
public class WheelSlotDisplay : MonoBehaviour,
    IPointerEnterHandler, IPointerExitHandler,
    IBeginDragHandler, IDragHandler, IEndDragHandler, IDropHandler  // ğŸ†•
{
    private bool _isDragging = false;
    private GameObject _dragGhost;  // æ‹–æ‹½å¹½çµå›¾åƒ
    private object _uiManager;      // UIç®¡ç†å™¨å¼•ç”¨

    public void OnBeginDrag(PointerEventData eventData)
    {
        if (_wheelItem == null || !_config.EnableDragSwap) return;
        _isDragging = true;
        CreateDragGhost();  // åˆ›å»ºåŠé€æ˜æ‹–æ‹½å›¾åƒ
    }

    public void OnDrag(PointerEventData eventData)
    {
        if (_dragGhost != null)
            _dragGhost.transform.position = eventData.position;
    }

    public void OnEndDrag(PointerEventData eventData)
    {
        _isDragging = false;
        if (_dragGhost != null) Destroy(_dragGhost);
    }

    public void OnDrop(PointerEventData eventData)
    {
        var draggedSlot = eventData.pointerDrag?.GetComponent<WheelSlotDisplay>();
        if (draggedSlot == null || draggedSlot == this) return;

        // é€šçŸ¥UIManageræ‰§è¡Œäº¤æ¢ï¼ˆä½¿ç”¨åå°„è°ƒç”¨ï¼‰
        var method = _uiManager?.GetType().GetMethod("SwapSlots");
        method?.Invoke(_uiManager, new object[] {
            draggedSlot.GetSlotIndex(),
            this.GetSlotIndex()
        });
    }
}
```

**ä½ç½®**: `QuickWheel/src/UI/WheelSlotDisplay.cs:299-392`

#### 6.2 `WheelUIManager.cs` - æ·»åŠ  SwapSlots æ–¹æ³•

```csharp
public void SwapSlots(int fromIndex, int toIndex)
{
    // è°ƒç”¨ Wheel æ ¸å¿ƒè¿›è¡Œæ•°æ®äº¤æ¢
    _wheel.SwapSlots(fromIndex, toIndex);  // è§¦å‘EventBusäº‹ä»¶

    // ç«‹å³åˆ·æ–°UIæ˜¾ç¤º
    RefreshSlot(fromIndex);
    RefreshSlot(toIndex);
}

private void RefreshSlot(int index)
{
    var display = _slotDisplays[index];
    var wheelItem = ConvertToWheelItem(_wheel.GetSlot(index));
    display.SetData(wheelItem);
}
```

**ä½ç½®**: `QuickWheel/src/UI/WheelUIManager.cs:320-361`

---

## ğŸ”„ å®Œæ•´äº‹ä»¶æµ

```
ç©å®¶æ‹–æ‹½è½®ç›˜ç‰©å“
    â†“
WheelSlotDisplay.OnBeginDrag â†’ åˆ›å»ºæ‹–æ‹½å¹½çµ
    â†“
WheelSlotDisplay.OnDrag â†’ è·Ÿéšé¼ æ ‡ç§»åŠ¨
    â†“
WheelSlotDisplay.OnDrop â†’ æ£€æµ‹ç›®æ ‡æ ¼å­
    â†“
WheelUIManager.SwapSlots(fromIndex, toIndex)
    â†“
Wheel.SwapSlots â†’ WheelStateManager.SwapSlots (äº¤æ¢æ•°æ®)
    â†“
WheelStateManagerè§¦å‘ â†’ OnSlotsSwappedäº‹ä»¶
    â†“
Wheel.HandleSlotsSwapped â†’ EventBus.TriggerSlotsSwapped
    â†“
EventBus.OnSlotsSwappedäº‹ä»¶è§¦å‘
    â†“
ItemWheelSystem.OnWheelSlotsSwapped (è®¢é˜…è€…)
    â†“
è·å–åŒå‘æ˜ å°„å…³ç³»ï¼š
  - fromWheelPos â†’ fromBackpackPos
  - toWheelPos â†’ toBackpackPos
    â†“
è®¾ç½®_isPerformingSwap = true (é˜²æ­¢é€’å½’)
    â†“
æƒ…å†µ1ï¼šç›®æ ‡æœ‰ç‰©å“ â†’ äº¤æ¢èƒŒåŒ…ç‰©å“
æƒ…å†µ2ï¼šç›®æ ‡ä¸ºç©º â†’ åªæ›´æ–°æ˜ å°„
    â†“
æ›´æ–°åŒå‘æ˜ å°„å…³ç³»
    â†“
_isPerformingSwap = false
    â†“
WheelUIManager.RefreshSlot â†’ åˆ·æ–°UIæ˜¾ç¤º
```

---

## ğŸ“‚ ä¿®æ”¹çš„æ–‡ä»¶

### ItemWheel é¡¹ç›®

1. **ItemWheelSystem.cs**
   - æ·»åŠ  `CategoryWheel.WheelToBackpackMapping` å’Œ `BackpackToWheelMapping`
   - æ·»åŠ  `_isPerformingSwap` é˜²é€’å½’æ ‡å¿—
   - ä¿®æ”¹ `RefreshCategorySlots` å»ºç«‹æ˜ å°„å…³ç³»
   - åœ¨ `EnsureWheel` ä¸­è®¢é˜… `OnSlotsSwapped` äº‹ä»¶
   - æ–°å¢ `OnWheelSlotsSwapped` æ–¹æ³•å¤„ç†èƒŒåŒ…åŒæ­¥

### QuickWheel æ¡†æ¶

2. **WheelSlotDisplay.cs**
   - å®ç° `IBeginDragHandler`, `IDragHandler`, `IEndDragHandler`, `IDropHandler` æ¥å£
   - æ·»åŠ æ‹–æ‹½å¹½çµå›¾åƒåŠŸèƒ½
   - æ·»åŠ  `OnDrop` æ–¹æ³•è§¦å‘äº¤æ¢

3. **WheelUIManager.cs**
   - æ–°å¢ `SwapSlots` æ–¹æ³•
   - æ–°å¢ `RefreshSlot` æ–¹æ³•
   - ä¿®æ”¹ `Initialize` ä¼ å…¥ `this` å¼•ç”¨ç»™ `WheelSlotDisplay`

---

## ğŸ¯ åŠŸèƒ½éªŒè¯

### æµ‹è¯•åœºæ™¯

#### æµ‹è¯•1ï¼šåŸºæœ¬äº¤æ¢
- [ ] æ‰“å¼€è½®ç›˜ï¼Œæ‹–æ‹½ç‰©å“Aåˆ°ç‰©å“Bä½ç½®
- [ ] å…³é—­è½®ç›˜ï¼Œæ‰“å¼€èƒŒåŒ…
- [ ] **éªŒè¯**: ç‰©å“Aå’ŒBåœ¨èƒŒåŒ…ä¸­çš„ä½ç½®å·²äº¤æ¢

#### æµ‹è¯•2ï¼šç©ºä½äº¤æ¢
- [ ] æ‹–æ‹½ç‰©å“åˆ°ç©ºä½
- [ ] **éªŒè¯**: è½®ç›˜æ˜¾ç¤ºæ­£å¸¸ï¼ŒèƒŒåŒ…ä½ç½®æœªæ”¹å˜ï¼ˆåªæ›´æ–°æ˜ å°„ï¼‰

#### æµ‹è¯•3ï¼šé‡æ–°æ‰“å¼€è½®ç›˜
- [ ] äº¤æ¢ç‰©å“åå…³é—­è½®ç›˜
- [ ] é‡æ–°æ‰“å¼€è½®ç›˜
- [ ] **éªŒè¯**: è½®ç›˜æ˜¾ç¤ºæ–°é¡ºåºï¼ˆæ˜ å°„å…³ç³»ä¿æŒï¼‰

#### æµ‹è¯•4ï¼šèƒŒåŒ…æ‰‹åŠ¨è°ƒæ•´
- [ ] åœ¨èƒŒåŒ…ä¸­æ‰‹åŠ¨è°ƒæ•´ç‰©å“é¡ºåº
- [ ] æ‰“å¼€è½®ç›˜
- [ ] **éªŒè¯**: è½®ç›˜æ˜¾ç¤ºèƒŒåŒ…æ–°é¡ºåºï¼ˆæ˜ å°„é‡å»ºï¼‰

#### æµ‹è¯•5ï¼šè·¨ç±»åˆ«ç‹¬ç«‹æ€§
- [ ] è°ƒæ•´åŒ»ç–—è½®ç›˜ç‰©å“
- [ ] æ‰“å¼€åˆºæ¿€å‰‚è½®ç›˜
- [ ] **éªŒè¯**: åˆºæ¿€å‰‚è½®ç›˜ä¸å—å½±å“

#### æµ‹è¯•6ï¼šé€’å½’é˜²æŠ¤
- [ ] å¿«é€Ÿè¿ç»­æ‹–æ‹½äº¤æ¢
- [ ] **éªŒè¯**: æ— å´©æºƒï¼Œæ— æ—¥å¿—è­¦å‘Š

---

## ğŸ› å·²çŸ¥é—®é¢˜

### éœ€è¦æµ‹è¯•çš„è¾¹ç•Œæƒ…å†µ

1. **ç‰©å“æ•°é‡å˜åŒ–**
   - å¦‚æœè½®ç›˜æ˜¾ç¤ºæ—¶èƒŒåŒ…æ·»åŠ /åˆ é™¤ç‰©å“ï¼Œæ˜ å°„å¯èƒ½å¤±æ•ˆ
   - å»ºè®®ï¼šç›‘å¬ `Inventory.onContentChanged` è‡ªåŠ¨åˆ·æ–°æ˜ å°„

2. **æ‹–æ‹½å¹½çµæ¸…ç†**
   - å¦‚æœè½®ç›˜åœ¨æ‹–æ‹½è¿‡ç¨‹ä¸­å…³é—­ï¼Œå¹½çµå¯èƒ½æ®‹ç•™
   - å»ºè®®ï¼šåœ¨ `HideWheel` æ—¶å¼ºåˆ¶æ¸…ç†æ‹–æ‹½çŠ¶æ€

3. **å¤šçº¿ç¨‹å®‰å…¨**
   - å½“å‰æ²¡æœ‰çº¿ç¨‹é”ï¼Œé«˜é¢‘æ“ä½œå¯èƒ½æœ‰ç«æ€æ¡ä»¶
   - å»ºè®®ï¼šæ·»åŠ æ“ä½œé˜Ÿåˆ—æˆ–é”æœºåˆ¶

---

## ğŸ“Š æ€§èƒ½è€ƒè™‘

### å†…å­˜å ç”¨
- æ¯ä¸ª `CategoryWheel` å¢åŠ ï¼š
  - `int[8]` (32 bytes)
  - `Dictionary<int, int>` (çº¦ 100 bytes)
  - æ€»è®¡æ¯ç±»åˆ«çº¦ **132 bytes**
  - 4ä¸ªç±»åˆ«æ€»è®¡ **~500 bytes**ï¼ˆå¯å¿½ç•¥ï¼‰

### CPUæ€§èƒ½
- æ‹–æ‹½äº¤æ¢ï¼šO(1) æ˜ å°„æŸ¥æ‰¾ + O(1) èƒŒåŒ…æ“ä½œ
- åˆ·æ–°æ˜ å°„ï¼šO(n) éå†ç‰©å“åˆ—è¡¨ï¼ˆn â‰¤ 8ï¼‰
- **æ€»ä½“æ€§èƒ½å½±å“ï¼šæå°**

---

## ğŸš€ åç»­ä¼˜åŒ–å»ºè®®

### ä¼˜å…ˆçº§ï¼šé«˜

1. **ç›‘å¬èƒŒåŒ…å˜åŒ–è‡ªåŠ¨åˆ·æ–°æ˜ å°„**
   - è®¢é˜… `Inventory.onContentChanged`
   - æ£€æµ‹ç‰©å“ç§»åŠ¨å¹¶æ›´æ–°æ˜ å°„

### ä¼˜å…ˆçº§ï¼šä¸­

2. **æ·»åŠ æ‹–æ‹½åŠ¨ç”»**
   - æ‹–æ‹½æ—¶æ ¼å­é«˜äº®
   - äº¤æ¢æ—¶æ·¡å…¥æ·¡å‡ºåŠ¨ç”»

3. **æŒä¹…åŒ–æ˜ å°„å…³ç³»**
   - ä¿å­˜æ˜ å°„åˆ°æœ¬åœ°æ–‡ä»¶
   - æ¸¸æˆé‡å¯åæ¢å¤å¸ƒå±€

### ä¼˜å…ˆçº§ï¼šä½

4. **å¤šé€‰æ‹–æ‹½**
   - æ”¯æŒ Shift/Ctrl å¤šé€‰
   - æ‰¹é‡è°ƒæ•´é¡ºåº

5. **æ‹–æ‹½æç¤º**
   - é¼ æ ‡æ‚¬åœæ˜¾ç¤ºç›®æ ‡ä½ç½®
   - ä¸å¯æ‹–æ‹½æ—¶æ˜¾ç¤ºç¦æ­¢å›¾æ ‡

---

## ğŸ’¡ æŠ€æœ¯äº®ç‚¹

1. **åŒå‘æ˜ å°„è®¾è®¡**
   - O(1) æŸ¥æ‰¾æ•ˆç‡
   - ç©ºé—´æ¢æ—¶é—´ï¼Œæ˜ å°„è¡¨æå°

2. **é˜²é€’å½’æœºåˆ¶**
   - `_isPerformingSwap` æ ‡å¿—ä¼˜é›…åœ°é˜²æ­¢äº‹ä»¶å¾ªç¯
   - å‚è€ƒäº† `MainBackpackWheelManager` çš„æˆç†Ÿæ–¹æ¡ˆ

3. **äº‹ä»¶é©±åŠ¨æ¶æ„**
   - è§£è€¦UIå’Œæ•°æ®é€»è¾‘
   - åˆ©ç”¨ QuickWheel çš„ EventBus

4. **æ³›å‹å…¼å®¹æ€§**
   - ä½¿ç”¨ `object` å’Œåå°„å¤„ç†æ³›å‹ç±»
   - ä¸ç ´å QuickWheel çš„é€šç”¨æ€§

5. **å®Œæ•´çš„æ‹–æ‹½å®ç°**
   - å¹½çµå›¾åƒè·Ÿéš
   - Unity EventSystem æ ‡å‡†æ¥å£
   - é€æ˜æ‹¦æˆªé˜²æ­¢è¯¯è§¦

---

## ğŸ“š å‚è€ƒèµ„æ–™

- **å‚è€ƒmod**: `Backpack_QuickWheel/code/src/ShortcutSystem/MainBackpackWheelManager.cs`
- **Unity EventSystem**: `IBeginDragHandler`, `IDragHandler`, `IEndDragHandler`, `IDropHandler`
- **åŒå‘æ˜ å°„æ¨¡å¼**: Bidirectional Map / Two-Way Dictionary

---

## âœ… åŠŸèƒ½çŠ¶æ€

| åŠŸèƒ½æ¨¡å— | çŠ¶æ€ |
|---------|------|
| åŒå‘æ˜ å°„æ•°æ®ç»“æ„ | âœ… å·²å®Œæˆ |
| åˆå§‹åŒ–æ˜ å°„å…³ç³» | âœ… å·²å®Œæˆ |
| é˜²æ­¢é€’å½’äº‹ä»¶ | âœ… å·²å®Œæˆ |
| è®¢é˜…æ§½ä½äº¤æ¢äº‹ä»¶ | âœ… å·²å®Œæˆ |
| èƒŒåŒ…åŒæ­¥é€»è¾‘ | âœ… å·²å®Œæˆ |
| QuickWheelæ‹–æ‹½UI | âœ… å·²å®Œæˆ |
| æ‹–æ‹½å¹½çµå›¾åƒ | âœ… å·²å®Œæˆ |
| UIåˆ·æ–°æœºåˆ¶ | âœ… å·²å®Œæˆ |
| ç¼–è¯‘é€šè¿‡ | âœ… å·²å®Œæˆ |
| **æ¸¸æˆå†…æµ‹è¯•** | â³ **å¾…æµ‹è¯•** |

---

## ğŸ‰ æ€»ç»“

æˆåŠŸå®ç°äº†å®Œæ•´çš„**è½®ç›˜æ‹–æ‹½åŒæ­¥èƒŒåŒ…**åŠŸèƒ½ï¼

### æ ¸å¿ƒæˆå°±
1. âœ… å®Œæ•´çš„åŒå‘æ˜ å°„æœºåˆ¶
2. âœ… ä¼˜é›…çš„é˜²é€’å½’è®¾è®¡
3. âœ… ä»é›¶å®ç°äº† QuickWheel çš„æ‹–æ‹½åŠŸèƒ½
4. âœ… äº‹ä»¶é©±åŠ¨çš„è§£è€¦æ¶æ„
5. âœ… å‚è€ƒäº†æˆç†Ÿmodçš„è®¾è®¡æ¨¡å¼

### ä¸‹ä¸€æ­¥
- **æ¸¸æˆå†…æµ‹è¯•éªŒè¯**
- **è¾¹ç•Œæƒ…å†µæµ‹è¯•**
- **æ€§èƒ½ç›‘æ§**
- **ç”¨æˆ·åé¦ˆæ”¶é›†**

---

*å®ç°æ—¥æœŸ: 2025-11-07*
*é¢„è®¡æµ‹è¯•æ—¶é—´: 30åˆ†é’Ÿ*
*æ€»ä»£ç è¡Œæ•°: ~400è¡Œ*
