# ItemWheel é¡¹ç›®è®°å¿†æ–‡æ¡£

*æ›´æ–°æ—¶é—´: 2025-11-07*

---

## ğŸ“‹ ç›®å½•

1. [é¡¹ç›®æ¦‚è¿°](#é¡¹ç›®æ¦‚è¿°)
2. [é¡¹ç›®ç»“æ„](#é¡¹ç›®ç»“æ„)
3. [æ¶æ„è®¾è®¡](#æ¶æ„è®¾è®¡)
4. [æ ¸å¿ƒåŠŸèƒ½](#æ ¸å¿ƒåŠŸèƒ½)
5. [å‚è€ƒå®ç°](#å‚è€ƒå®ç°)
6. [æ¸¸æˆAPI](#æ¸¸æˆapi)
7. [å¾…åŠäº‹é¡¹](#å¾…åŠäº‹é¡¹)

---

## é¡¹ç›®æ¦‚è¿°

### åŸºæœ¬ä¿¡æ¯

- **é¡¹ç›®åç§°**: ItemWheel
- **é¡¹ç›®è·¯å¾„**: `D:\02_projects\Mod\Duckov\ItemWheel\`
- **ç›®æ ‡æ¸¸æˆ**: Escape from Duckov
- **ç›®æ ‡æ¡†æ¶**: .NET Standard 2.1
- **ä¸»ç¨‹åºé›†**: ItemWheel
- **æ ¹å‘½åç©ºé—´**: ItemWheel

### é¡¹ç›®ç›®æ ‡

ä¸º Escape from Duckov æ¸¸æˆåˆ›å»ºä¸€ä¸ªå¿«æ·ç‰©å“è½®ç›˜ç³»ç»Ÿï¼Œæ”¯æŒï¼š
- 4ä¸ªç‰©å“ç±»åˆ«çš„å¿«æ·è½®ç›˜ï¼ˆåŒ»ç–—ã€åˆºæ¿€å‰‚ã€é£Ÿç‰©ã€çˆ†ç‚¸ç‰©ï¼‰
- 9å®«æ ¼å¸ƒå±€ï¼ˆ8ä¸ªç‰©å“ä½ç½® + ä¸­å¿ƒç©ºä½ï¼‰
- é•¿æŒ‰æ˜¾ç¤ºè½®ç›˜ï¼ŒçŸ­æŒ‰ç›´æ¥ä½¿ç”¨
- è½®ç›˜æ‹–æ‹½è°ƒæ•´ç‰©å“é¡ºåºï¼ŒåŒæ­¥åˆ°èƒŒåŒ…

### å…³é”®é…ç½®

```xml
<!-- ItemWheel.csproj -->
<DuckovPath>D:\steam\steamapps\common\Escape from Duckov</DuckovPath>
<OutputPath>$(DuckovPath)\Duckov_Data\Mods\ItemWheel</OutputPath>
```

### QuickWheel é›†æˆ

- **æºç è·¯å¾„**: `../QuickWheel/src/**/*.cs`
- **é›†æˆæ–¹å¼**: ç›´æ¥åŒ…å«æºç ç¼–è¯‘åˆ° ItemWheel.dll
- **ä¸æ˜¯NuGetåŒ…**: å†…åµŒåˆ°æ¨¡ç»„ä¸­ï¼Œä¸ä½œä¸ºç‹¬ç«‹åº“

---

## é¡¹ç›®ç»“æ„

```
ItemWheel/
â”œâ”€â”€ ItemWheelSystem.cs         # ä¸»è¦è½®ç›˜ç³»ç»Ÿï¼ˆä¸šåŠ¡é€»è¾‘ï¼‰
â”œâ”€â”€ ItemWheelAdapter.cs        # ç‰©å“é€‚é…å™¨ï¼ˆQuickWheelé€‚é…ï¼‰
â”œâ”€â”€ ModBehaviour.cs            # æ¨¡ç»„å…¥å£ï¼ˆHarmony patchesï¼‰
â”œâ”€â”€ document/                  # é¡¹ç›®æ–‡æ¡£
â”‚   â”œâ”€â”€ é¡¹ç›®è®°å¿†æ–‡æ¡£.md
â”‚   â””â”€â”€ å‚è€ƒæ¨¡æ¿.drawio
â”œâ”€â”€ Texture/                   # UIç´ æ
â”‚   â”œâ”€â”€ WheelSlot_Normal.png
â”‚   â”œâ”€â”€ WheelSlot_Hover.png
â”‚   â””â”€â”€ WheelSlot_Selected.png
â””â”€â”€ GameSource/                # æ¸¸æˆæºç å‚è€ƒï¼ˆä¸ç¼–è¯‘ï¼‰

QuickWheel/src/
â”œâ”€â”€ Core/
â”‚   â”œâ”€â”€ Wheel.cs              # è½®ç›˜ä¸»ç±»
â”‚   â””â”€â”€ WheelBuilder.cs       # æ„å»ºå™¨
â”œâ”€â”€ Selection/
â”‚   â””â”€â”€ GridSelectionStrategy.cs  # 9å®«æ ¼é€‰æ‹©ç­–ç•¥
â”œâ”€â”€ Input/
â”‚   â””â”€â”€ MouseWheelInput.cs    # é¼ æ ‡è¾“å…¥å¤„ç†
â”œâ”€â”€ UI/
â”‚   â”œâ”€â”€ DefaultWheelView.cs   # é»˜è®¤è§†å›¾
â”‚   â””â”€â”€ WheelSlotDisplay.cs   # æ ¼å­æ˜¾ç¤º
â””â”€â”€ Interfaces/               # æ¥å£å®šä¹‰
    â”œâ”€â”€ IWheelAdapter.cs
    â”œâ”€â”€ IWheelInput.cs
    â”œâ”€â”€ IWheelView.cs
    â””â”€â”€ IWheelSelectionStrategy.cs
```

---

## æ¶æ„è®¾è®¡

### QuickWheel æ¶æ„

```
Wheel (æ ¸å¿ƒ)
  â”œâ”€â”€ IWheelAdapter<T>        # æ•°æ®é€‚é…å™¨ï¼ˆç‰©å“ç±»å‹è½¬æ¢ï¼‰
  â”œâ”€â”€ IWheelInput             # è¾“å…¥å¤„ç†ï¼ˆé¼ æ ‡ã€é”®ç›˜ï¼‰
  â”œâ”€â”€ IWheelView<T>           # è§†å›¾æ˜¾ç¤ºï¼ˆUIæ¸²æŸ“ï¼‰
  â””â”€â”€ IWheelSelectionStrategy # é€‰æ‹©ç­–ç•¥ï¼ˆ9å®«æ ¼ã€ç¯å½¢ç­‰ï¼‰

äº‹ä»¶æµ:
InputHandler â†’ SelectionStrategy â†’ View â†’ Adapter
     â†“              â†“                â†“        â†“
  é¼ æ ‡ç§»åŠ¨    è®¡ç®—é€‰ä¸­ç´¢å¼•      æ›´æ–°UI    è·å–æ•°æ®
```

### ItemWheel å®ç°

```
ModBehaviour
  â”œâ”€â”€ Harmony Patches          # æ‹¦æˆªæ¸¸æˆå¿«æ·é”®ï¼ˆ3-6ï¼‰
  â”‚   â”œâ”€â”€ OnShortCutInput3-6  # è½¬å‘åˆ° ItemWheelSystem
  â”‚   â”œâ”€â”€ OnMouseTriggerInput # é˜»æ­¢å¼€ç«
  â”‚   â””â”€â”€ OnMouseScrollerInput # é˜»æ­¢åˆ‡æ¢æ­¦å™¨
  â”‚
  â””â”€â”€ ItemWheelSystem         # ä¸šåŠ¡é€»è¾‘
      â”œâ”€â”€ CategoryWheel[4]    # 4ä¸ªç±»åˆ«çš„è½®ç›˜å®ä¾‹
      â”œâ”€â”€ KeyStateç®¡ç†        # é•¿æŒ‰/çŸ­æŒ‰æ£€æµ‹
      â”œâ”€â”€ Wheelæ˜¾ç¤º/éšè—      # è½®ç›˜ç”Ÿå‘½å‘¨æœŸ
      â””â”€â”€ ç‰©å“ä½¿ç”¨é€»è¾‘        # UseItem/EquipItem
```

### æ•°æ®æµ

```
ç©å®¶æŒ‰ä¸‹å¿«æ·é”®
  â†“
ModBehaviour.HandleShortcutContext
  â†“
ItemWheelSystem.OnKeyPressed
  â†“
[é•¿æŒ‰è®¡æ—¶æ£€æµ‹]
  â†“
ItemWheelSystem.ShowWheel
  â†“
Wheel.Show() â†’ View.Show() â†’ æ˜¾ç¤ºUI
  â†“
[ç©å®¶ç§»åŠ¨é¼ æ ‡]
  â†“
MouseWheelInput.OnUpdate() â†’ GridSelectionStrategy.SelectItem()
  â†“
[ç©å®¶æ¾å¼€å¿«æ·é”®]
  â†“
ItemWheelSystem.OnKeyReleased
  â†“
çŸ­æŒ‰ï¼šUseShortcutDirect()
é•¿æŒ‰ï¼šConfirmWheelSelection() â†’ OnItemSelected() â†’ UseItem()
```

---

## æ ¸å¿ƒåŠŸèƒ½

### 1. å¿«æ·é”®æ‹¦æˆªï¼ˆå·²å®Œæˆ âœ…ï¼‰

**æ–‡ä»¶**: `ModBehaviour.cs:51-152`

- **æ‹¦æˆªæŒ‰é”®**: æ¸¸æˆå¿«æ·é”® 3-6ï¼ˆå¯¹åº”åŒ»ç–—/åˆºæ¿€å‰‚/é£Ÿç‰©/çˆ†ç‚¸ç‰©ï¼‰
- **é˜»æ­¢åŸè¡Œä¸º**: `return false` é˜»æ­¢æ¸¸æˆé»˜è®¤å¿«æ·é”®é€»è¾‘
- **é˜»æ­¢å‰¯ä½œç”¨**:
  - é˜»æ­¢é¼ æ ‡è§¦å‘ï¼ˆé˜²æ­¢å¼€ç«ï¼‰
  - é˜»æ­¢é¼ æ ‡æ»šè½®ï¼ˆé˜²æ­¢åˆ‡æ¢æ­¦å™¨ï¼‰

### 2. é•¿æŒ‰/çŸ­æŒ‰æ£€æµ‹ï¼ˆå·²å®Œæˆ âœ…ï¼‰

**æ–‡ä»¶**: `ItemWheelSystem.cs:183-245`

```csharp
KeyState çŠ¶æ€æœº:
æŒ‰ä¸‹ â†’ è®¡æ—¶å¼€å§‹ â†’ è¶…è¿‡0.15s?
                    â”œâ”€ æ˜¯ â†’ æ˜¾ç¤ºè½®ç›˜ï¼ˆé•¿æŒ‰ï¼‰
                    â””â”€ å¦ â†’ ç›´æ¥ä½¿ç”¨ï¼ˆçŸ­æŒ‰ï¼‰
```

### 3. 9å®«æ ¼å¸ƒå±€ï¼ˆå·²å®Œæˆ âœ…ï¼‰

**æ–‡ä»¶**: `GridSelectionStrategy.cs`

```
[7] [2] [6]    å·¦ä¸Š ä¸Šä¸­ å³ä¸Š
[0] [ ] [1]    å·¦ä¸­ ä¸­å¿ƒ å³ä¸­
[4] [3] [5]    å·¦ä¸‹ ä¸‹ä¸­ å³ä¸‹

è§’åº¦æ˜ å°„ï¼ˆUnityåæ ‡ç³»ï¼ŒYå‘ä¸Šä¸ºæ­£ï¼‰ï¼š
- 2ï¼ˆä¸Šä¸­ï¼‰: 247.5Â° - 292.5Â°
- 3ï¼ˆä¸‹ä¸­ï¼‰: 67.5Â° - 112.5Â°
- Yè½´ä¿®æ­£: direction.y â†’ -direction.y
```

**å·²ä¿®å¤çš„Bug**:
- Yè½´åæ ‡ç³»åè½¬é—®é¢˜ï¼šUnity Yå‘ä¸Šï¼Œå±å¹•Yå‘ä¸‹
- è§£å†³æ–¹æ¡ˆï¼š`Vector2 correctedDirection = new Vector2(direction.x, -direction.y);`

### 4. è‡ªå®šä¹‰æ ¼å­Spriteï¼ˆå·²å®Œæˆ âœ…ï¼‰

**æ–‡ä»¶**: `ItemWheelSystem.cs:75-109`

- **åŠ è½½è·¯å¾„**: `$(ModPath)/texture/WheelSlot_*.png`
- **ä¸‰ç§çŠ¶æ€**: Normal / Hover / Selected
- **åŠ è½½å·¥å…·**: `SpriteLoader.LoadFromFile()`
- **è½®ç›˜èƒŒæ™¯**: å®Œå…¨é€æ˜ï¼ˆ`Color.clear`ï¼‰

### 5. ç‰©å“å›¾æ ‡æ˜¾ç¤ºï¼ˆå·²ä¿®å¤ âœ…ï¼‰

**æ–‡ä»¶**: `WheelSlotDisplay.cs`

- **é—®é¢˜**: åªåœ¨åˆå§‹åŒ–æ—¶æœ‰æ•°æ®æ‰åˆ›å»ºå›¾æ ‡å¯¹è±¡
- **ä¿®å¤**: æ€»æ˜¯åˆ›å»ºå›¾æ ‡å’Œæ ‡ç­¾å¯¹è±¡ï¼Œç”¨ `SetActive()` æ§åˆ¶æ˜¾ç¤º

### 6. è½®ç›˜ä¸èƒŒåŒ…åŒæ­¥ï¼ˆ**å¾…å®ç°** âš ï¸ï¼‰

**å½“å‰çŠ¶æ€**:
- âœ… èƒŒåŒ…ç‰©å“é¡ºåº â†’ è½®ç›˜å¸ƒå±€ï¼ˆå·²å®ç°ï¼‰
- âŒ æ‹–æ‹½è½®ç›˜ç‰©å“ â†’ æ”¹å˜èƒŒåŒ…é¡ºåºï¼ˆ**æœªå®ç°**ï¼‰

**å‚è€ƒå®ç°**: `MainBackpackWheelManager.cs`ï¼ˆBackpack_QuickWheelæ¨¡ç»„ï¼‰

---

## å‚è€ƒå®ç°

### MainBackpackWheelManagerï¼ˆå‚è€ƒæ¨¡ç»„ï¼‰

**æ–‡ä»¶**: `../Backpack_QuickWheel/code/src/ShortcutSystem/MainBackpackWheelManager.cs`

#### æ ¸å¿ƒæ¦‚å¿µ

**åŒå‘æ˜ å°„**:
```csharp
// è½®ç›˜ä½ç½® â†’ èƒŒåŒ…ä½ç½®
Dictionary<ItemCategory, int[]> _categoryToWheelPositions
// ä¾‹: Medicalç±»åˆ«ï¼Œè½®ç›˜ä½ç½®0 â†’ èƒŒåŒ…ä½ç½®5

// èƒŒåŒ…ä½ç½® â†’ è½®ç›˜ä½ç½®ï¼ˆåå‘ç´¢å¼•ï¼‰
Dictionary<ItemCategory, Dictionary<int, int>> _categoryToBackpackPositions
// ä¾‹: Medicalç±»åˆ«ï¼ŒèƒŒåŒ…ä½ç½®5 â†’ è½®ç›˜ä½ç½®0
```

#### å…³é”®åŠŸèƒ½

**1. èƒŒåŒ…å˜åŒ–ç›‘å¬**

```csharp
_mainBackpackInventory.onContentChanged += OnMainBackpackContentChanged;

private void OnMainBackpackContentChanged(Inventory inventory, int changedSlot)
{
    // æ£€æµ‹ç‰©å“ç§»åŠ¨ï¼šæŸ¥æ‰¾ç‰©å“çš„æ—§ä½ç½®
    int oldPos = FindItemInCache(currentItem);

    if (oldPos != -1) {
        // ç‰©å“ç§»åŠ¨ï¼šæ›´æ–°æ˜ å°„å…³ç³»
        HandleItemRemoval(oldPos);
        HandleNewItemInsertion(changedSlot, ...);
    }
}
```

**2. è½®ç›˜æ‹–æ‹½åŒæ­¥**

```csharp
WheelLayoutManager.OnSlotsSwapped += OnWheelSlotsSwapped;

private void OnWheelSlotsSwapped(ItemCategory category, int fromWheelPos, int toWheelPos)
{
    // è·å–æ˜ å°„å…³ç³»
    int fromBackpackPos = categoryWheelMapping[fromWheelPos];
    int toBackpackPos = categoryWheelMapping[toWheelPos];

    // æ–¹æ¡ˆ1ï¼šäº¤æ¢èƒŒåŒ…ä½ç½®ï¼ˆåŒå‘äº¤æ¢ï¼‰
    if (toBackpackPos != -1) {
        item.Detach();
        targetItem.Detach();
        _mainBackpackInventory.AddAt(targetItem, fromBackpackPos);
        _mainBackpackInventory.AddAt(item, toBackpackPos);
    }

    // æ–¹æ¡ˆ2ï¼šåªæ›´æ–°æ˜ å°„ï¼Œä¸æ“ä½œèƒŒåŒ…ï¼ˆå•å‘ç§»åŠ¨ï¼‰
    else {
        categoryWheelMapping[toWheelPos] = fromBackpackPos;
        categoryBackpackMapping[fromBackpackPos] = toWheelPos;
    }
}
```

**3. é‡æ’åºæœºåˆ¶**

```csharp
private void ResortCategoryWheel(ItemCategory category)
{
    // æ”¶é›†å½“å‰ç±»åˆ«çš„æ‰€æœ‰ç‰©å“å’ŒèƒŒåŒ…ä½ç½®
    var wheelItems = new List<(int wheelPos, int backpackPos, Item item)>();

    // æŒ‰èƒŒåŒ…ä½ç½®ä»å°åˆ°å¤§æ’åº
    wheelItems.Sort((a, b) => a.backpackPos.CompareTo(b.backpackPos));

    // é‡æ–°å»ºç«‹æ˜ å°„
    for (int i = 0; i < wheelItems.Count; i++) {
        categoryWheelMapping[i] = wheelItems[i].backpackPos;
        categoryBackpackMapping[wheelItems[i].backpackPos] = i;
    }

    // åŒæ­¥åˆ°UI
    _wheelLayoutManager.SyncFromMapping(category, categoryWheelMapping, ...);
}
```

#### è®¾è®¡ä¼˜åŠ¿

1. **æŒ‰ç±»åˆ«ç‹¬ç«‹æ˜ å°„**: æ¯ä¸ªç±»åˆ«ï¼ˆåŒ»ç–—/åˆºæ¿€å‰‚/é£Ÿç‰©/çˆ†ç‚¸ç‰©ï¼‰æœ‰è‡ªå·±çš„8ä½ç½®è½®ç›˜
2. **å¢é‡æ›´æ–°**: åªæ›´æ–°å˜åŒ–çš„æ§½ä½ï¼Œé¿å…å…¨é‡åˆ·æ–°
3. **äº‹ä»¶æ ‡å¿—ä¿æŠ¤**: `_isPerformingSwap` é˜²æ­¢é€’å½’äº‹ä»¶è§¦å‘
4. **ç‰©å“ç§»åŠ¨è·Ÿè¸ª**: ç¼“å­˜æ—§ä½ç½®ï¼Œæ£€æµ‹ç§»åŠ¨è€Œéæ’å…¥/åˆ é™¤

---

## æ¸¸æˆAPI

### Item ç±»

**æ–‡ä»¶**: `../æ›´èªæ˜çš„æ•Œäºº/Gamesource/Duckov/Item.cs`

```csharp
public class Item : MonoBehaviour
{
    public int TypeID { get; }
    public int Order { get; set; }           // èƒŒåŒ…ä½ç½®é¡ºåº
    public string DisplayName { get; }
    public string Description { get; }
    public Sprite Icon { get; }
    public List<ItemTag> Tags { get; }       // ç‰©å“æ ‡ç­¾ï¼ˆç”¨äºåˆ†ç±»ï¼‰

    // ç‰©å“æ“ä½œ
    public void Detach();                    // ä»å½“å‰å®¹å™¨ç§»é™¤
    public UsageUtilities UsageUtilities;    // ä½¿ç”¨å·¥å…·
}
```

### ItemDisplay ç±»

**æ–‡ä»¶**: `../æ›´èªæ˜çš„æ•Œäºº/Gamesource/Duckov/ItemDisplay.cs`

```csharp
public class ItemDisplay : MonoBehaviour
{
    public Item Target { get; }
    public bool Selected { get; }

    public void Setup(Item target);          // è®¾ç½®æ˜¾ç¤ºçš„ç‰©å“

    // äº‹ä»¶
    public event Action<ItemDisplay, PointerEventData> onDoubleClicked;
    public event Action<PointerEventData> onReceiveDrop;

    // UIç»„ä»¶
    private Image icon;
    private TextMeshProUGUI itemName;
}
```

### Inventory ç±»

**æ–‡ä»¶**: `../Backpack_QuickWheel/code/GameSource/Duckov/Inventory.cs`

```csharp
public class Inventory
{
    public List<Item> Content { get; }       // ç‰©å“åˆ—è¡¨

    public Item GetItemAt(int index);        // è·å–æŒ‡å®šä½ç½®ç‰©å“
    public void AddAt(Item item, int index); // åœ¨æŒ‡å®šä½ç½®æ·»åŠ ç‰©å“

    // äº‹ä»¶ï¼šå‚æ•°(Inventory inventory, int changedSlot)
    public event Action<Inventory, int> onContentChanged;
}
```

### CharacterMainControl ç±»

```csharp
public class CharacterMainControl
{
    public static CharacterMainControl Main; // ä¸»è§’è‰²å•ä¾‹

    public CharacterItem CharacterItem;      // ç‰©å“ç®¡ç†
    public ItemAgentHolder agentHolder;      // æ‰‹æŒç‰©å“ç®¡ç†

    public void UseItem(Item item);          // ä½¿ç”¨ç‰©å“
}
```

---

## å¾…åŠäº‹é¡¹

### ğŸ¯ ä¸»è¦åŠŸèƒ½

#### 1. å®ç°è½®ç›˜æ‹–æ‹½åŒæ­¥åˆ°èƒŒåŒ…

**ä¼˜å…ˆçº§**: â­â­â­ **æœ€é«˜**

**éœ€æ±‚**:
- ç©å®¶åœ¨è½®ç›˜ä¸Šæ‹–æ‹½ç‰©å“äº¤æ¢ä½ç½®æ—¶ï¼ŒåŒæ­¥æ›´æ–°èƒŒåŒ…ä¸­çš„ç‰©å“é¡ºåº
- ä¿æŒè½®ç›˜å¸ƒå±€ä¸èƒŒåŒ…é¡ºåºä¸€è‡´

**å‚è€ƒ**:
- `MainBackpackWheelManager.OnWheelSlotsSwapped()` (è¡Œ1247-1261)
- `MainBackpackWheelManager.AdjustWheelPosition()` (è¡Œ1271-1374)

**å®ç°æ­¥éª¤**:
1. åœ¨ `ItemWheelSystem` ä¸­æ·»åŠ åŒå‘æ˜ å°„æœºåˆ¶
   - `int[] _wheelToBackpackMapping[category]`
   - `Dictionary<int, int> _backpackToWheelMapping[category]`

2. ç›‘å¬ QuickWheel çš„æ§½ä½äº¤æ¢äº‹ä»¶
   - åœ¨ `WheelBuilder` ä¸­æ·»åŠ  `.OnSlotsSwapped()` å›è°ƒ
   - æˆ–åœ¨ `DefaultWheelView` ä¸­æš´éœ²äº‹ä»¶

3. å®ç°äº¤æ¢é€»è¾‘
   ```csharp
   private void OnWheelSlotsSwapped(ItemWheelCategory category, int from, int to)
   {
       int fromBackpackPos = _wheelToBackpackMapping[from];
       int toBackpackPos = _wheelToBackpackMapping[to];

       if (toBackpackPos != -1) {
           // äº¤æ¢èƒŒåŒ…ä½ç½®
           var item1 = _inventory.GetItemAt(fromBackpackPos);
           var item2 = _inventory.GetItemAt(toBackpackPos);

           item1.Detach();
           item2.Detach();
           _inventory.AddAt(item2, fromBackpackPos);
           _inventory.AddAt(item1, toBackpackPos);
       }

       // æ›´æ–°æ˜ å°„å…³ç³»
       SwapMappings(category, from, to);
   }
   ```

4. é˜²æ­¢é€’å½’äº‹ä»¶
   - æ·»åŠ  `_isPerformingSwap` æ ‡å¿—
   - åœ¨ `RefreshCategorySlots` ä¸­æ£€æŸ¥æ ‡å¿—

**éªŒè¯**:
- [ ] æ‹–æ‹½è½®ç›˜ç‰©å“åï¼Œæ‰“å¼€èƒŒåŒ…ï¼Œç‰©å“é¡ºåºå·²æ”¹å˜
- [ ] å…³é—­è½®ç›˜ï¼Œé‡æ–°æ‰“å¼€ï¼Œæ–°é¡ºåºä¿æŒ
- [ ] åœ¨èƒŒåŒ…ä¸­æ‰‹åŠ¨è°ƒæ•´é¡ºåºï¼Œè½®ç›˜åŒæ­¥æ›´æ–°

---

#### 2. å®Œå–„ QuickWheel äº‹ä»¶ç³»ç»Ÿ

**ä¼˜å…ˆçº§**: â­â­ ä¸­ç­‰

**éœ€æ±‚**:
- QuickWheel å½“å‰æ²¡æœ‰æš´éœ²æ§½ä½äº¤æ¢äº‹ä»¶
- éœ€è¦åœ¨ `DefaultWheelView` æˆ– `Wheel` ä¸­æ·»åŠ äº‹ä»¶

**å®ç°ä½ç½®**:
- `QuickWheel/src/UI/DefaultWheelView.cs`
- `QuickWheel/src/Core/Wheel.cs`

**å»ºè®®API**:
```csharp
// åœ¨ Wheel.cs ä¸­æ·»åŠ 
public event Action<int, int> OnSlotsSwapped;

// åœ¨ WheelSlotDisplay æ‹–æ‹½å®Œæˆæ—¶è§¦å‘
protected virtual void OnSlotSwapped(int fromIndex, int toIndex)
{
    OnSlotsSwapped?.Invoke(fromIndex, toIndex);
}
```

---

#### 3. åˆå§‹åŒ–æ˜ å°„å…³ç³»

**ä¼˜å…ˆçº§**: â­â­ ä¸­ç­‰

**éœ€æ±‚**:
- åœ¨é¦–æ¬¡æ˜¾ç¤ºè½®ç›˜æ—¶ï¼Œå»ºç«‹è½®ç›˜ä½ç½®ä¸èƒŒåŒ…ä½ç½®çš„æ˜ å°„
- ä»èƒŒåŒ…é¡ºåºåˆå§‹åŒ–æ˜ å°„è¡¨

**å®ç°ä½ç½®**: `ItemWheelSystem.RefreshCategorySlots()`

```csharp
private void InitializeMapping(CategoryWheel wheel)
{
    var items = CollectItemsForCategory(wheel.Category);

    for (int i = 0; i < items.Count && i < 8; i++)
    {
        var item = items[i];
        int backpackPos = _inventory.Content.IndexOf(item);

        wheel.WheelToBackpackMapping[i] = backpackPos;
        wheel.BackpackToWheelMapping[backpackPos] = i;
    }
}
```

---

### ğŸ› å·²çŸ¥é—®é¢˜

#### 1. è½®ç›˜å…³é—­åç‰©å“æ•°æ®è¿‡æœŸ

**çŠ¶æ€**: âš ï¸ å¯èƒ½å·²ä¿®å¤ï¼ˆéœ€æµ‹è¯•ï¼‰

**ç°è±¡**:
- è½®ç›˜æ˜¾ç¤ºåï¼Œä¿®æ”¹èƒŒåŒ…ç‰©å“
- å…³é—­è½®ç›˜å†æ¬¡æ‰“å¼€ï¼Œæ˜¾ç¤ºæ—§æ•°æ®

**å¯èƒ½åŸå› **:
- `CategoryWheel.Slots` ç¼“å­˜äº†æ—§æ•°æ®
- `RefreshCategorySlots` æœªè¢«è°ƒç”¨

**ä¿®å¤æ–¹æ¡ˆ**:
- å‚è€ƒ `ItemWheelSelector.RefreshWheelItems()` (è¡Œ361-413)
- åœ¨ `ShowWheel` æ—¶å¼ºåˆ¶åˆ·æ–°æ•°æ®

---

### ğŸ”§ ä»£ç ä¼˜åŒ–

#### 1. å‡å°‘æ—¥å¿—è¾“å‡º

**ä¼˜å…ˆçº§**: â­ ä½

**å½“å‰é—®é¢˜**:
- Debug.Log è¿‡å¤šï¼Œå½±å“æ€§èƒ½
- ç”Ÿäº§ç¯å¢ƒä¸éœ€è¦è°ƒè¯•æ—¥å¿—

**å»ºè®®**:
- æ·»åŠ  `#if DEBUG` æ¡ä»¶ç¼–è¯‘
- æˆ–ä½¿ç”¨æ—¥å¿—ç­‰çº§ç³»ç»Ÿ

---

#### 2. æå–å¸¸é‡é…ç½®

**ä¼˜å…ˆçº§**: â­ ä½

**å»ºè®®**:
- å°†é­”æ³•æ•°å­—æå–åˆ° `WheelConfig.cs`
- ä¾‹å¦‚ï¼šé•¿æŒ‰é˜ˆå€¼ `0.15f`ã€æ ¼å­å¤§å° `90f`

---

### ğŸ“š æ–‡æ¡£å®Œå–„

#### 1. APIæ–‡æ¡£

**ä¼˜å…ˆçº§**: â­ ä½

**éœ€è¦**:
- ä¸º `ItemWheelSystem` å…¬å…±APIæ·»åŠ XMLæ³¨é‡Š
- ç”Ÿæˆä½¿ç”¨æ–‡æ¡£

#### 2. æ¶æ„å›¾

**ä¼˜å…ˆçº§**: â­ ä½

**éœ€è¦**:
- ä½¿ç”¨ draw.io ç»˜åˆ¶å®Œæ•´æ¶æ„å›¾
- åŒ…æ‹¬æ•°æ®æµã€äº‹ä»¶æµ

---

## ğŸ’¡ å®ç°å»ºè®®

### æ‹–æ‹½åŒæ­¥ä¼˜å…ˆçº§å®ç°é¡ºåº

1. **ç¬¬ä¸€æ­¥**: åœ¨ `ItemWheelSystem` ä¸­æ·»åŠ æ˜ å°„æ•°æ®ç»“æ„
   - ä¿®æ”¹ `CategoryWheel` ç±»ï¼Œæ·»åŠ æ˜ å°„å­—æ®µ
   - åœ¨ `RefreshCategorySlots` ä¸­å»ºç«‹åˆå§‹æ˜ å°„

2. **ç¬¬äºŒæ­¥**: åœ¨ QuickWheel ä¸­æ·»åŠ æ§½ä½äº¤æ¢äº‹ä»¶
   - ä¿®æ”¹ `Wheel.cs` æ·»åŠ  `OnSlotsSwapped` äº‹ä»¶
   - åœ¨ `WheelSlotDisplay` æ‹–æ‹½å®Œæˆæ—¶è§¦å‘äº‹ä»¶

3. **ç¬¬ä¸‰æ­¥**: åœ¨ `ItemWheelSystem` ä¸­ç›‘å¬äº‹ä»¶å¹¶åŒæ­¥èƒŒåŒ…
   - åœ¨ `EnsureWheel` ä¸­è®¢é˜…äº‹ä»¶
   - å®ç° `OnWheelSlotsSwapped` æ–¹æ³•
   - æ·»åŠ  `_isPerformingSwap` é˜²æ­¢é€’å½’

4. **ç¬¬å››æ­¥**: æµ‹è¯•éªŒè¯
   - å•å…ƒæµ‹è¯•ï¼šæ˜ å°„æ­£ç¡®æ€§
   - é›†æˆæµ‹è¯•ï¼šèƒŒåŒ…åŒæ­¥
   - è¾¹ç•Œæµ‹è¯•ï¼šç©ºä½äº¤æ¢ã€è¶Šç•Œ

---

## ğŸ“ å¼€å‘æ³¨æ„äº‹é¡¹

### 1. Unity åæ ‡ç³»

- Unityåæ ‡ç³»ï¼šYå‘ä¸Šä¸ºæ­£
- å±å¹•åæ ‡ç³»ï¼šYå‘ä¸‹ä¸ºæ­£
- æ¶‰åŠè§’åº¦è®¡ç®—æ—¶æ³¨æ„è½¬æ¢

### 2. Harmony Patch

- Prefixè¿”å› `false` é˜»æ­¢åŸæ–¹æ³•æ‰§è¡Œ
- Postfixå¯ä»¥ä¿®æ”¹ç»“æœ
- æ³¨æ„æ€§èƒ½å½±å“ï¼Œé¿å…é«˜é¢‘patch

### 3. ç‰©å“æ“ä½œ

- `item.Detach()` åç‰©å“è„±ç¦»åŸå®¹å™¨
- `inventory.AddAt(item, index)` ä¼šè§¦å‘ `onContentChanged` äº‹ä»¶
- é˜²æ­¢é€’å½’ï¼šä½¿ç”¨æ ‡å¿—ä½

### 4. æµ‹è¯•ç¯å¢ƒ

- æ¸¸æˆè·¯å¾„: `D:\steam\steamapps\common\Escape from Duckov`
- Modè¾“å‡º: `$(GamePath)\Duckov_Data\Mods\ItemWheel`
- çƒ­é‡è½½ï¼šä¿®æ”¹ä»£ç åéœ€é‡å¯æ¸¸æˆ

---

## ğŸ”— ç›¸å…³é“¾æ¥

- **æ¸¸æˆ**: Escape from Duckov (Steam)
- **æ¡†æ¶**: Unity + Harmony
- **ä¾èµ–**: QuickWheel (è‡ªåˆ¶è½®ç›˜æ¡†æ¶)

---

## ğŸ“… æ›´æ–°æ—¥å¿—

### 2025-11-07
- åˆ›å»ºé¡¹ç›®è®°å¿†æ–‡æ¡£
- æ•´ç†ç°æœ‰åŠŸèƒ½å’Œæ¶æ„
- æ·»åŠ å‚è€ƒå®ç°åˆ†æ
- åˆ—å‡ºå¾…åŠäº‹é¡¹æ¸…å•
