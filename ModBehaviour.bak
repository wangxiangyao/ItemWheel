using System;
using Duckov;
using HarmonyLib;
using ItemStatsSystem;
using UnityEngine;
using UnityEngine.InputSystem;

namespace ItemWheel
{
    public class ModBehaviour : Duckov.Modding.ModBehaviour
    {
        private static ModBehaviour _instance;

        private Harmony _harmony;
        private ItemWheelSystem _wheelSystem;

        private void Awake()
        {
            if (_instance != null && _instance != this)
            {
                Destroy(gameObject);
                return;
            }

            _instance = this;
            DontDestroyOnLoad(gameObject);

            _wheelSystem = new ItemWheelSystem();


            _harmony = new Harmony("com.duckov.itemwheel");
            _harmony.PatchAll(typeof(ModBehaviour).Assembly);
        }

        private void Update()
        {
            // æ¯å¸§æ›´æ–°è½®ç›˜ç³»ç»Ÿ
            _wheelSystem?.Update();
        }

        private void OnDestroy()
        {
            if (_instance == this)
            {
                _harmony?.UnpatchAll(_harmony.Id);
                _wheelSystem?.Dispose();
                _instance = null;
            }
        }

        [HarmonyPatch(typeof(CharacterInputControl))]
        private static class CharacterInputPatch
        {
            [HarmonyPatch("OnShortCutInput3")]
            [HarmonyPrefix]
            private static bool OnShortCutInput3(InputAction.CallbackContext context)
            {
                return Forward(context, 0);
            }

            [HarmonyPatch("OnShortCutInput4")]
            [HarmonyPrefix]
            private static bool OnShortCutInput4(InputAction.CallbackContext context)
            {
                return Forward(context, 1);
            }

            [HarmonyPatch("OnShortCutInput5")]
            [HarmonyPrefix]
            private static bool OnShortCutInput5(InputAction.CallbackContext context)
            {
                return Forward(context, 2);
            }

            [HarmonyPatch("OnShortCutInput6")]
            [HarmonyPrefix]
            private static bool OnShortCutInput6(InputAction.CallbackContext context)
            {
                return Forward(context, 3);
            }

            /// <summary>
            /// è¿‘æˆ˜å¿«æ·é”®ï¼ˆVï¼‰æ‹¦æˆªï¼šå‘¼å‡º/ç¡®è®¤è¿‘æˆ˜è½®ç›˜
            /// </summary>
            [HarmonyPatch("OnPlayerSwitchItemAgentMelee")]
            [HarmonyPrefix]
            private static bool OnPlayerSwitchItemAgentMelee_Prefix(InputAction.CallbackContext context)
            {
                if (_instance == null)
                {
                    return true;
                }

                try
                {
                    if (context.started || (context.performed && !context.canceled))
                    {
                        _instance._wheelSystem.OnKeyPressed(ItemWheelSystem.ItemWheelCategory.Melee);
                    }

                    if (context.canceled)
                    {
                        _instance._wheelSystem.OnKeyReleased(ItemWheelSystem.ItemWheelCategory.Melee);
                    }
                }
                catch (Exception ex)
                {
                    Debug.LogError($"[ItemWheel] å¤„ç†è¿‘æˆ˜å¿«æ·é”®å¤±è´? {ex}");
                    return true;
                }

                // é˜»æ­¢åŸæ–¹æ³•ï¼Œé¿å…ä¸å®˜æ–¹è¿‘æˆ˜åˆ‡æ¢é€»è¾‘å†²çª
                return false;
            }

            private static bool Forward(InputAction.CallbackContext context, int shortcutIndex)
            {
                var instance = _instance;
                if (_instance == null)
                {
                    return true;
                }

                try
                {
                    return _instance.HandleShortcutContext(shortcutIndex, context);
                }
                catch (Exception ex)
                {
                    Debug.LogError($"[ItemWheel] Failed to process shortcut index {shortcutIndex}: {ex}");
                    return true;
                }
            }

            /// <summary>
            /// Patch é¼ æ ‡è§¦å‘è¾“å…¥ï¼ˆå·¦é”®ç‚¹å‡?å¼€ç«ï¼‰
            /// å½“è½®ç›˜æ˜¾ç¤ºæ—¶ï¼Œæ¸…é™¤è§¦å‘æ ‡å¿—ï¼Œé˜²æ­¢æ¸¸æˆå¼€ç?            /// </summary>
            [HarmonyPatch("OnPlayerTriggerInputUsingMouseKeyboard")]
            [HarmonyPostfix]
            private static void OnPlayerTriggerInputPostfix(CharacterInputControl __instance)
            {
                // å½“è½®ç›˜æ˜¾ç¤ºæ—¶ï¼Œæ¸…é™¤æ‰€æœ‰è§¦å‘æ ‡å¿?                if (_instance?._wheelSystem?.HasActiveWheel == true)
                {
                    try
                    {
                        // ä½¿ç”¨åå°„æ¸…é™¤ç§æœ‰å­—æ®µ
                        var type = typeof(CharacterInputControl);

                        var field1 = type.GetField("mouseKeyboardTriggerInputThisFrame",
                            System.Reflection.BindingFlags.NonPublic | System.Reflection.BindingFlags.Instance);
                        field1?.SetValue(__instance, false);

                        var field2 = type.GetField("mouseKeyboardTriggerInput",
                            System.Reflection.BindingFlags.NonPublic | System.Reflection.BindingFlags.Instance);
                        field2?.SetValue(__instance, false);

                        var field3 = type.GetField("mouseKeyboardTriggerReleaseThisFrame",
                            System.Reflection.BindingFlags.NonPublic | System.Reflection.BindingFlags.Instance);
                        field3?.SetValue(__instance, false);
                    }
                    catch (Exception ex)
                    {
                        Debug.LogError($"[ItemWheel] Failed to clear trigger flags: {ex}");
                    }
                }
            }

            /// <summary>
            /// Patch é¼ æ ‡æ»šè½®è¾“å…¥
            /// å½“è½®ç›˜æ˜¾ç¤ºæ—¶ï¼Œé˜»æ­¢é¼ æ ‡æ»šè½®ï¼ˆé˜²æ­¢åˆ‡æ¢æ­¦å™¨ï¼?            /// </summary>
            [HarmonyPatch("OnMouseScollerInput")]
            [HarmonyPrefix]
            private static bool OnMouseScrollerInputPrefix(InputAction.CallbackContext context)
            {
                // å½“è½®ç›˜æ˜¾ç¤ºæ—¶ï¼Œé˜»æ­¢é¼ æ ‡æ»šè½®è¾“å…?                if (_instance?._wheelSystem?.HasActiveWheel == true)
                {
                    return false;  // é˜»æ­¢åŸæ–¹æ³•æ‰§è¡?                }

                return true;  // å…è®¸åŸæ–¹æ³•æ‰§è¡?            }
        }

        /// <summary>
        /// å¤„ç†å¿«æ·é”®è¾“å…?        /// æ‹¦æˆªå®˜æ–¹å¿«æ·é”®ï¼Œè½¬å‘ç»™è½®ç›˜ç³»ç»Ÿå¤„ç?        /// </summary>
        private bool HandleShortcutContext(int shortcutIndex, InputAction.CallbackContext context)
        {
            // æ ¹æ®å¿«æ·é”®ç´¢å¼•è·å–å¯¹åº”çš„ç‰©å“ç±»åˆ«
            var category = GetItemCategoryForShortcut(shortcutIndex);

            if (context.started || (context.performed && !context.canceled))
            {
                // æŒ‰é”®æŒ‰ä¸‹ï¼šé€šçŸ¥è½®ç›˜ç³»ç»Ÿå¼€å§‹ç›‘å¬é•¿æŒ?                _wheelSystem.OnKeyPressed(category);
            }

            if (context.canceled)
            {
                // æŒ‰é”®æ¾å¼€ï¼šé€šçŸ¥è½®ç›˜ç³»ç»Ÿç»“æŸç›‘å¬
                _wheelSystem.OnKeyReleased(category);
            }

            // é˜»æ­¢æ¸¸æˆé»˜è®¤çš„å¿«æ·é”®è¡Œä¸º
            return false;
        }

        /// <summary>
        /// æ ¹æ®å¿«æ·é”®ç´¢å¼•è·å–ç‰©å“ç±»åˆ?        /// è¿™å¯¹åº”æ¸¸æˆçš„å¿«æ·é”®è®¾ç½®ï¼š3=åŒ»ç–—, 4=åˆºæ¿€å‰? 5=é£Ÿç‰©, 6=çˆ†ç‚¸ç‰?        /// </summary>
        private static ItemWheelSystem.ItemWheelCategory GetItemCategoryForShortcut(int shortcutIndex)
        {
            return shortcutIndex switch
            {
                0 => ItemWheelSystem.ItemWheelCategory.Medical,   // å®˜æ–¹å¿«æ·é”?
                1 => ItemWheelSystem.ItemWheelCategory.Stim,      // å®˜æ–¹å¿«æ·é”?
                2 => ItemWheelSystem.ItemWheelCategory.Food,      // å®˜æ–¹å¿«æ·é”?
                3 => ItemWheelSystem.ItemWheelCategory.Explosive, // å®˜æ–¹å¿«æ·é”?
                _ => ItemWheelSystem.ItemWheelCategory.Medical
            };
        }

      
    }
}

