# ItemWheel é‡æ„æ‰§è¡Œè®¡åˆ’ï¼ˆå®é™…ç‰ˆï¼‰

## ğŸ“… åŸºæœ¬ä¿¡æ¯
- **å¼€å§‹æ—¥æœŸ**: 2025-11-12
- **å½“å‰åˆ†æ”¯**: `refactor/itemwheel-architecture`
- **é‡æ„æ–¹å¼**: åˆ†é˜¶æ®µæ¸è¿›å¼é‡æ„ï¼ˆ4ä¸ªé˜¶æ®µï¼‰

## ğŸ¯ é‡æ„ç›®æ ‡

### æ ¸å¿ƒéœ€æ±‚
1. âœ… **é…ç½®ç”Ÿæ•ˆ**: ModSettingä¸­çš„é…ç½®èƒ½æ­£ç¡®è¯»å–å’Œåº”ç”¨
2. â³ **å¤šèƒŒåŒ…æœç´¢**: æ”¯æŒæœç´¢å® ç‰©èƒŒåŒ…ä¸­çš„ç‰©å“
3. â³ **æ‹–æ‹½æ§åˆ¶**: å¯ç”¨å® ç‰©/å®¹å™¨æœç´¢æ—¶ç¦ç”¨æ‹–æ‹½
4. â³ **æ¨¡å—åŒ–ç®¡ç†**: ä¸åŒè½®ç›˜åˆ†å¼€ç®¡ç†ï¼Œå…¬ç”¨æ–¹æ³•ï¼Œä¾¿äºå•ç‹¬ä¿®æ”¹

### æ¶æ„ç›®æ ‡
```
é‡æ„å‰: ItemWheelSystem.cs (1751è¡Œ) - åŒ…å«æ‰€æœ‰åŠŸèƒ½
é‡æ„å:
â”œâ”€â”€ Core/
â”‚   â”œâ”€â”€ SettingsManager.cs          # é…ç½®ç»Ÿä¸€è®¿é—®
â”‚   â”œâ”€â”€ ItemCollector.cs            # ç‰©å“æœç´¢é€»è¾‘
â”‚   â”œâ”€â”€ WheelFactory.cs             # è½®ç›˜åˆ›å»ºï¼ˆæ§åˆ¶æ‹–æ‹½ï¼‰
â”‚   â””â”€â”€ ItemWheelCoordinator.cs     # åè°ƒå™¨ï¼ˆç®€åŒ–ç‰ˆï¼‰
â”œâ”€â”€ Handlers/
â”‚   â”œâ”€â”€ IItemHandler.cs             # å¤„ç†å™¨æ¥å£
â”‚   â”œâ”€â”€ DefaultItemHandler.cs       # é€šç”¨å¤„ç†å™¨
â”‚   â”œâ”€â”€ ExplosiveHandler.cs         # æ‰‹é›·é€»è¾‘
â”‚   â””â”€â”€ MeleeHandler.cs             # è¿‘æˆ˜é€»è¾‘
â”œâ”€â”€ Data/
â”‚   â”œâ”€â”€ CollectedItemInfo.cs        # æœç´¢ç»“æœï¼ˆæ·»åŠ IsFromPetï¼‰
â”‚   â”œâ”€â”€ CategoryWheel.cs            # è½®ç›˜ä¸Šä¸‹æ–‡
â”‚   â””â”€â”€ ItemWheelCategory.cs        # ç±»åˆ«æšä¸¾
â”œâ”€â”€ UI/
â”‚   â””â”€â”€ SpriteLoader.cs             # SpriteåŠ è½½
â””â”€â”€ Integration/
    â”œâ”€â”€ ModSettingFacade.cs         # ModSettingé—¨é¢
    â””â”€â”€ ItemWheelModSettings.cs     # é…ç½®æ•°æ®ç±»
```

---

## ğŸš¦ é˜¶æ®µ1ï¼šåŸºç¡€è®¾æ–½ï¼ˆ40åˆ†é’Ÿï¼‰

### ç›®æ ‡
åˆ›å»ºåŸºç¡€ç±»ï¼Œç»Ÿä¸€é…ç½®è®¿é—®ï¼Œä¸æ”¹åŠ¨ç°æœ‰é€»è¾‘

### å·¥ä½œå†…å®¹

#### 1.1 åˆ›å»ºé…ç½®åŸºç¡€ç±»
- [ ] `Integration/ModSettingFacade.cs` - ModSettingç»Ÿä¸€é—¨é¢
- [ ] `Integration/ItemWheelModSettings.cs` - é…ç½®æ•°æ®ç±»
- [ ] `Core/SettingsManager.cs` - ç®€åŒ–é…ç½®è®¿é—®

**é…ç½®é¡¹**:
```csharp
public class ItemWheelModSettings
{
    // æœç´¢è®¾ç½®
    public bool SearchInSlots { get; set; } = true;
    public bool SearchInPetInventory { get; set; } = true;

    // è½®ç›˜å¼€å…³
    public bool EnableMedicalWheel { get; set; } = true;
    public bool EnableStimWheel { get; set; } = true;
    public bool EnableFoodWheel { get; set; } = true;
    public bool EnableExplosiveWheel { get; set; } = true;
    public bool EnableMeleeWheel { get; set; } = true;
    public bool EnableAmmoWheel { get; set; } = true;

    // UIè®¾ç½®
    public bool ShowItemCount { get; set; } = true;
    public bool ShowDurabilityBar { get; set; } = true;
    public bool ShowName { get; set; } = true;
    public bool ShowRightText { get; set; } = true;
}
```

#### 1.2 åˆ›å»ºSpriteåŠ è½½å™¨
- [ ] `UI/SpriteLoader.cs` - ç»Ÿä¸€SpriteåŠ è½½
- [ ] æ›¿æ¢ ItemWheelSystem å’Œ AmmoWheelSystem ä¸­çš„é‡å¤ä»£ç 

#### 1.3 ä¿®æ”¹ModBehaviour
- [ ] ä½¿ç”¨ `ModSettingFacade.Initialize()` æ›¿ä»£ç›´æ¥è°ƒç”¨ `ModSettingAPI`
- [ ] ç§»é™¤æ‰€æœ‰ `ModSettingAPI.AddToggle()` è°ƒç”¨ï¼ˆæ”¹ä¸ºç”±Facadeç»Ÿä¸€ç®¡ç†ï¼‰

### æµ‹è¯•æ¸…å•
- [ ] æ¸¸æˆèƒ½æ­£å¸¸å¯åŠ¨
- [ ] é…ç½®é¢æ¿æ˜¾ç¤ºæ‰€æœ‰é€‰é¡¹
- [ ] ä¿®æ”¹é…ç½®åèƒ½æ­£ç¡®ä¿å­˜
- [ ] Spriteæ­£ç¡®åŠ è½½
- [ ] æ—¥å¿—æ˜¾ç¤º `[ItemWheel] ModSetting initialized successfully`

### å›é€€æ–¹æ¡ˆ
å¦‚æœå‡ºé—®é¢˜ï¼š
```bash
git reset --hard HEAD
```

---

## ğŸš¦ é˜¶æ®µ2ï¼šå¤šèƒŒåŒ…æœç´¢ï¼ˆ45åˆ†é’Ÿï¼‰

### ç›®æ ‡
å®ç°éœ€æ±‚ #1 å’Œ #2ï¼šé…ç½®ç”Ÿæ•ˆ + æ”¯æŒå® ç‰©èƒŒåŒ…æœç´¢

### å·¥ä½œå†…å®¹

#### 2.1 æ‰©å±•æ•°æ®ç»“æ„
- [ ] ä¿®æ”¹ `CollectedItemInfo` æ·»åŠ  `IsFromPet` å­—æ®µ
- [ ] å°† `CollectedItemInfo` ç§»åˆ°ç‹¬ç«‹æ–‡ä»¶ `Data/CollectedItemInfo.cs`
- [ ] å°† `CategoryWheel` ç§»åˆ°ç‹¬ç«‹æ–‡ä»¶ `Data/CategoryWheel.cs`

#### 2.2 åˆ›å»ºæœç´¢é€»è¾‘
- [ ] `Core/ItemCollector.cs` - å°è£… `CollectItemsForCategory` é€»è¾‘
- [ ] é›†æˆ `InventorySearcher` æ”¯æŒå¤šèƒŒåŒ…
- [ ] æ ¹æ®é…ç½®å†³å®šæœç´¢èŒƒå›´ï¼š
  - `SearchInSlots=true` â†’ æœç´¢å®¹å™¨
  - `SearchInPetInventory=true` â†’ æœç´¢å® ç‰©èƒŒåŒ…

**å®ç°è¦ç‚¹**:
```csharp
public static class ItemCollector
{
    public static List<CollectedItemInfo> Collect(
        Inventory mainInventory,
        ItemWheelCategory category,
        ItemWheelModSettings settings)
    {
        // 1. ç¡®å®šæœç´¢æº
        var inventories = InventorySearcher.GetInventoriesToSearch(
            mainInventory,
            settings.SearchInPetInventory
        );

        // 2. æœç´¢æ‰€æœ‰èƒŒåŒ…
        var results = InventorySearcher.SearchAll(
            inventories,
            item => MatchesCategory(item, category),
            settings.SearchInSlots
        );

        // 3. è½¬æ¢ä¸º CollectedItemInfoï¼ˆæ·»åŠ IsFromPetæ ‡è®°ï¼‰
        // 4. å¤„ç†æ‰‹é›·å †å é€»è¾‘
        return collectedItems;
    }
}
```

#### 2.3 ä¿®æ”¹ItemWheelSystem
- [ ] `CollectItemsForCategory()` è°ƒç”¨ `ItemCollector.Collect()`
- [ ] ä½¿ç”¨ `SettingsManager` è·å–é…ç½®

### æµ‹è¯•æ¸…å•
- [ ] èƒ½æœç´¢åˆ°ä¸»èƒŒåŒ…ç‰©å“
- [ ] å¯ç”¨å® ç‰©æœç´¢åï¼Œèƒ½æœç´¢åˆ°å® ç‰©èƒŒåŒ…ç‰©å“
- [ ] å¯ç”¨å®¹å™¨æœç´¢åï¼Œèƒ½æœç´¢åˆ°å®¹å™¨å†…ç‰©å“
- [ ] é…ç½®ç¦ç”¨åï¼Œä¸æœç´¢å¯¹åº”èŒƒå›´
- [ ] ç‰©å“ä¸é‡å¤
- [ ] æ‰‹é›·å †å æ­£å¸¸

### éªŒè¯æ–¹æ³•
1. åœ¨èƒŒåŒ…æ”¾åŒ»ç–—å“
2. åœ¨å® ç‰©èƒŒåŒ…æ”¾åŒ»ç–—å“
3. åœ¨å®¹å™¨é‡Œæ”¾åŒ»ç–—å“
4. æ‰“å¼€åŒ»ç–—å“è½®ç›˜ï¼Œåº”è¯¥èƒ½çœ‹åˆ°æ‰€æœ‰ç‰©å“
5. å…³é—­å®¹å™¨æœç´¢ï¼Œå®¹å™¨å†…ç‰©å“ä¸æ˜¾ç¤º
6. å…³é—­å® ç‰©æœç´¢ï¼Œå® ç‰©èƒŒåŒ…ç‰©å“ä¸æ˜¾ç¤º

---

## ğŸš¦ é˜¶æ®µ3ï¼šæ‹–æ‹½æ§åˆ¶ï¼ˆ30åˆ†é’Ÿï¼‰

### ç›®æ ‡
å®ç°éœ€æ±‚ #3ï¼šæ ¹æ®æœç´¢æºæ§åˆ¶æ‹–æ‹½

### å·¥ä½œå†…å®¹

#### 3.1 åˆ›å»ºè½®ç›˜å·¥å‚
- [ ] `Core/WheelFactory.cs` - ç»Ÿä¸€è½®ç›˜åˆ›å»ºé€»è¾‘
- [ ] æ ¹æ®æœç´¢ç»“æœå†³å®š `EnableDragSwap`

**æ‹–æ‹½è§„åˆ™**:
```csharp
// å¦‚æœæœ‰ä»¥ä¸‹æƒ…å†µï¼Œç¦ç”¨æ‹–æ‹½ï¼š
// 1. æœç´¢ç»“æœåŒ…å«å® ç‰©èƒŒåŒ…ç‰©å“ï¼ˆIsFromPet=trueï¼‰
// 2. é…ç½®å¯ç”¨äº†å®¹å™¨æœç´¢ï¼ˆSearchInSlots=trueï¼‰ä¸”æœ‰å®¹å™¨ç‰©å“
bool ShouldDisableDrag(List<CollectedItemInfo> items, ItemWheelModSettings settings)
{
    // æœ‰å® ç‰©ç‰©å“ â†’ ç¦ç”¨æ‹–æ‹½
    if (items.Any(i => i.IsFromPet))
        return true;

    // å¯ç”¨å®¹å™¨æœç´¢ä¸”æœ‰å®¹å™¨ç‰©å“ â†’ ç¦ç”¨æ‹–æ‹½
    if (settings.SearchInSlots && items.Any(i => i.IsFromSlot))
        return true;

    return false;
}
```

#### 3.2 ä¿®æ”¹ItemWheelSystem
- [ ] `EnsureWheel()` ä½¿ç”¨ `WheelFactory.Create()`
- [ ] `RefreshCategorySlots()` æ ¹æ®æœç´¢ç»“æœåŠ¨æ€è°ƒæ•´æ‹–æ‹½çŠ¶æ€

**å®ç°æ–¹æ¡ˆ**:
- **æ–¹æ¡ˆAï¼ˆä¼˜å…ˆï¼‰**: è¿è¡Œæ—¶ä¿®æ”¹ `wheel.Config.EnableDragSwap`
- **æ–¹æ¡ˆBï¼ˆå¤‡é€‰ï¼‰**: çŠ¶æ€å˜åŒ–æ—¶é‡å»ºè½®ç›˜

### æµ‹è¯•æ¸…å•
- [ ] åªæœ‰ä¸»èƒŒåŒ…ç‰©å“æ—¶ï¼Œæ‹–æ‹½å¯ç”¨
- [ ] æœ‰å® ç‰©èƒŒåŒ…ç‰©å“æ—¶ï¼Œæ‹–æ‹½ç¦ç”¨
- [ ] å¯ç”¨å®¹å™¨æœç´¢ä¸”æœ‰å®¹å™¨ç‰©å“æ—¶ï¼Œæ‹–æ‹½ç¦ç”¨
- [ ] é…ç½®æ”¹å˜åï¼Œæ‹–æ‹½çŠ¶æ€æ­£ç¡®æ›´æ–°
- [ ] æ‹–æ‹½ç¦ç”¨æ—¶ï¼Œå°è¯•æ‹–æ‹½æ— æ•ˆæœ

### éªŒè¯æ–¹æ³•
1. åªåœ¨ä¸»èƒŒåŒ…æ”¾ç‰©å“ â†’ æ‰“å¼€è½®ç›˜ â†’ å¯æ‹–æ‹½
2. åœ¨å® ç‰©èƒŒåŒ…æ”¾ç‰©å“ â†’ æ‰“å¼€è½®ç›˜ â†’ ä¸å¯æ‹–æ‹½
3. å…³é—­å® ç‰©æœç´¢ â†’ æ‰“å¼€è½®ç›˜ â†’ å¯æ‹–æ‹½
4. å¯ç”¨å®¹å™¨æœç´¢ï¼Œåœ¨å®¹å™¨æ”¾ç‰©å“ â†’ æ‰“å¼€è½®ç›˜ â†’ ä¸å¯æ‹–æ‹½

---

## ğŸš¦ é˜¶æ®µ4ï¼šHandleråˆ†ç¦»ï¼ˆ1å°æ—¶ï¼‰

### ç›®æ ‡
å®ç°éœ€æ±‚ #4ï¼šæ¨¡å—åŒ–ç®¡ç†ï¼Œä¾¿äºå•ç‹¬ä¿®æ”¹

### å·¥ä½œå†…å®¹

#### 4.1 åˆ›å»ºHandleræ¥å£
- [ ] `Handlers/IItemHandler.cs` - å¤„ç†å™¨æ¥å£

```csharp
public interface IItemHandler
{
    ItemWheelCategory Category { get; }
    void UseItem(Item item, CharacterMainControl character, CategoryWheel wheel);
    void OnItemSelected(Item item, int index, CategoryWheel wheel);
    void OnWheelShown(CategoryWheel wheel);
    int GetPreferredIndex(CategoryWheel wheel);
}
```

#### 4.2 åˆ›å»ºHandlerå®ç°
- [ ] `Handlers/DefaultItemHandler.cs` - åŒ»ç–—/åˆºæ¿€/é£Ÿç‰©
- [ ] `Handlers/ExplosiveHandler.cs` - æ‰‹é›·å †å é€»è¾‘
- [ ] `Handlers/MeleeHandler.cs` - è¿‘æˆ˜è£…å¤‡é€»è¾‘

**æŠ½å–é€»è¾‘**:
- `ExplosiveHandler`:
  - æ‰‹é›·å †å ï¼ˆæŒ‰TypeIDåˆ†ç»„ï¼‰
  - ä»åå¾€å‰ä½¿ç”¨é€»è¾‘
  - `UseItem()` ä¸­çš„æ‰‹é›·ç‰¹æ®Šå¤„ç†

- `MeleeHandler`:
  - è£…å¤‡åˆ°è¿‘æˆ˜æ§½
  - hoverå³è£…å¤‡
  - `EquipMeleeItem()` é€»è¾‘
  - `TrySetMeleeDefaultSelection()` é€»è¾‘

#### 4.3 åˆ›å»ºåè°ƒå™¨
- [ ] `Core/ItemWheelCoordinator.cs` - ç®€åŒ–ç‰ˆItemWheelSystem
- [ ] ä½¿ç”¨Handleræ¨¡å¼åˆ†å‘é€»è¾‘
- [ ] ä¿ç•™æ ¸å¿ƒåè°ƒåŠŸèƒ½ï¼š
  - è½®ç›˜ç”Ÿå‘½å‘¨æœŸç®¡ç†
  - æŒ‰é”®çŠ¶æ€ç®¡ç†
  - èƒŒåŒ…ç›‘å¬
  - æ˜ å°„æŒä¹…åŒ–

#### 4.4 é‡æ„ItemWheelSystem
- [ ] ç§»é™¤å·²æŠ½å–çš„é€»è¾‘
- [ ] ä½¿ç”¨Handlerå¤„ç†ä¸åŒç±»åˆ«
- [ ] ä¿æŒå¯¹å¤–æ¥å£ä¸å˜

### æµ‹è¯•æ¸…å•
- [ ] æ‰€æœ‰è½®ç›˜æ­£å¸¸æ˜¾ç¤º
- [ ] åŒ»ç–—å“/åˆºæ¿€/é£Ÿç‰©è½®ç›˜æ­£å¸¸ä½¿ç”¨
- [ ] æ‰‹é›·è½®ç›˜å †å æ˜¾ç¤ºæ­£ç¡®
- [ ] æ‰‹é›·ä»åå¾€å‰æ¶ˆè€—
- [ ] è¿‘æˆ˜è½®ç›˜hoverå³è£…å¤‡
- [ ] è¿‘æˆ˜çŸ­æŒ‰Våˆ‡æ¢æ­¦å™¨
- [ ] æ‹–æ‹½åŒæ­¥åˆ°èƒŒåŒ…
- [ ] èƒŒåŒ…å˜åŒ–è‡ªåŠ¨åˆ·æ–°

### ä»£ç è¡Œæ•°ç›®æ ‡
- `ItemWheelCoordinator.cs`: ~300è¡Œ
- `ExplosiveHandler.cs`: ~150è¡Œ
- `MeleeHandler.cs`: ~100è¡Œ
- `DefaultItemHandler.cs`: ~50è¡Œ
- å…¶ä»–è¾…åŠ©ç±»: æ¯ä¸ª ~100è¡Œ

---

## ğŸ“Š æ€»ä½“è¿›åº¦

| é˜¶æ®µ | çŠ¶æ€ | é¢„è®¡æ—¶é—´ | å®é™…æ—¶é—´ | è´Ÿè´£äºº |
|------|------|---------|---------|--------|
| é˜¶æ®µ1ï¼šåŸºç¡€è®¾æ–½ | âœ… å®Œæˆ | 40åˆ†é’Ÿ | çº¦35åˆ†é’Ÿ | Claude |
| é˜¶æ®µ2ï¼šå¤šèƒŒåŒ…æœç´¢ | â³ å¾…å¼€å§‹ | 45åˆ†é’Ÿ | - | - |
| é˜¶æ®µ3ï¼šæ‹–æ‹½æ§åˆ¶ | â³ å¾…å¼€å§‹ | 30åˆ†é’Ÿ | - | - |
| é˜¶æ®µ4ï¼šHandleråˆ†ç¦» | â³ å¾…å¼€å§‹ | 1å°æ—¶ | - | - |
| **æ€»è®¡** | | **çº¦3å°æ—¶** | - | |

---

## ğŸ¯ æˆåŠŸæ ‡å‡†

é‡æ„å®Œæˆåï¼š
- [ ] æ‰€æœ‰åŸæœ‰åŠŸèƒ½æ­£å¸¸å·¥ä½œ
- [ ] ModSettingé…ç½®å…¨éƒ¨ç”Ÿæ•ˆ
- [ ] æ”¯æŒå¤šèƒŒåŒ…æœç´¢ï¼ˆä¸»èƒŒåŒ…+å® ç‰©èƒŒåŒ…+å®¹å™¨ï¼‰
- [ ] æ‹–æ‹½æ§åˆ¶æ­£ç¡®
- [ ] ä»£ç æ¨¡å—åŒ–ï¼Œä¾¿äºå•ç‹¬ä¿®æ”¹
- [ ] ItemWheelSystem.cs ä» 1751è¡Œ å‡å°‘åˆ° ~300è¡Œ
- [ ] æ— ç¼–è¯‘é”™è¯¯å’Œè­¦å‘Š
- [ ] æ€§èƒ½æ— æ˜æ˜¾ä¸‹é™

---

## ğŸ“ é‡æ„æ—¥å¿—

| æ—¥æœŸ | é˜¶æ®µ | æ“ä½œ | çŠ¶æ€ | å¤‡æ³¨ |
|------|------|------|------|------|
| 2025-11-12 | å‡†å¤‡ | åˆ›å»ºé‡æ„è®¡åˆ’ | âœ… å®Œæˆ | ç¡®å®šåˆ†é˜¶æ®µæ–¹æ¡ˆ |
| 2025-11-12 | é˜¶æ®µ1 | åŸºç¡€è®¾æ–½ | âœ… å®Œæˆ | åˆ›å»ºé…ç½®ç±»ã€SpriteLoaderã€ä¿®æ”¹ModBehaviour |
| 2025-11-12 | é˜¶æ®µ1 | ç¼–è¯‘æµ‹è¯• | âœ… å®Œæˆ | ç¼–è¯‘æˆåŠŸï¼Œæ— é”™è¯¯æ— è­¦å‘Š |

---

## ğŸ†˜ é—®é¢˜è®°å½•

æ— 

---

## ğŸ“Œ ä¸‹ä¸€æ­¥

**å½“å‰ä»»åŠ¡**: é˜¶æ®µ1 - åˆ›å»º `ModSettingFacade.cs` å’Œ `ItemWheelModSettings.cs`

**å‡†å¤‡å¥½ç»§ç»­äº†å—ï¼Ÿ** ğŸš€
